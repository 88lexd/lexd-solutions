---
- name: Probe peers
  shell: |
    gluster peer probe workernode1
    gluster peer probe glusterarb

- name: Check if volume already exist
  shell: gluster volume list | grep -Po '^k8s-volume$' || echo "NOT_EXIST"
  register: gluster_volume_status
  changed_when: False  # Task will return ok instead of changed

- name: Configure Gluster Volume
  shell: |
    gluster volume create k8s-volume replica 2 arbiter 1 transport tcp \
      masternode.lexd.local:/gluster/k8s_volume \
      workernode1.lexd.local:/gluster/k8s_volume \
      glusterarb.lexd.local:/gluster/k8s_volume
  when: gluster_volume_status.stdout == "NOT_EXIST"

- name: Check if volume already started
  shell: gluster volume info k8s-volume | grep '^Status' | grep Started || echo "NOT_STARTED"
  register: volume_start_status
  changed_when: False  # Task will return ok instead of changed

- name: Start the volume
  shell: gluster volume start k8s-volume
  when: volume_start_status.stdout == "NOT_STARTED"